// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  USER_LOGIN
  USER_LOGOUT
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  ROLE_ASSIGNED
  ROLE_REVOKED
  IMPERSONATION_STARTED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  DONE
  CANCELED
}

enum AutomationInstanceStatus {
  PENDING
  PENDING_CONFIG
  ACTIVE
  FAILED
}

enum AutomationAccessStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MarketplaceTemplateStatus {
  PENDING
  APPROVED
}

enum ConversationStatus {
  NEW
  CONTACTED
  PROPOSAL
  OPEN
  CLOSED
}

enum MessageDirection {
  IN
  OUT
  SYSTEM
}

enum NotificationType {
  CONVERSATION_ASSIGNED
  INBOUND_MESSAGE
  SLA_BREACH
  MARKETPLACE_INTEREST
}

enum CustomFieldEntity {
  COMPANY
  CONTACT
  DEAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  BOOLEAN
}

enum ActivityEntity {
  DEAL
  CONTACT
  COMPANY
}

enum ActivityType {
  CALL
  EMAIL
  NOTE
  MEETING
}

enum WebhookEvent {
  DEAL_WON
  CONTACT_CREATED
}

enum IntegrationAccountType {
  OPENAI
  WHATSAPP
  N8N
  INSTAGRAM_DIRECT
  FACEBOOK_MESSENGER
  EMAIL
  VOIP
}

enum IntegrationAccountStatus {
  ACTIVE
  INACTIVE
}

enum OtpPurpose {
  LOGIN
  SIGNUP
}

enum UserRole {
  ADMIN
  USER
}

enum CustomerType {
  PERSON
  COMPANY
}

enum CustomerStatus {
  LEAD
  ACTIVE
  INACTIVE
  CHURNED
}

enum SubscriptionStatus {
  ACTIVE
  PENDING
  IN_PROCESS
  REJECTED
  CANCELED
}

enum WorkspaceMembershipRole {
  OWNER
  MEMBER
}

enum WorkspaceMembershipStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AgentTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AgentAuditAction {
  IMPORTED
  PUBLISHED
  ACTIVATED
  DEACTIVATED
  ROLLED_BACK
  UPDATED
  DELETED
  ASSIGNED
  EXPIRED
}

enum AiUsageAction {
  SUMMARIZE_CONVERSATION
  CLASSIFY_LEAD
  SUGGEST_REPLY
  EXTRACT_FIELDS
}

enum AiUsageStatus {
  SUCCESS
  ERROR
}

model HealthCheck {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
}

model Workspace {
  id                  String    @id @default(uuid())
  name                String
  code                String    @unique
  passwordHash        String
  brandName           String?
  brandLogoUrl        String?
  brandPrimaryColor   String?
  brandSecondaryColor String?
  customDomain        String?
  locale              String    @default("pt-BR")
  deletedAt           DateTime?
  retentionEndsAt     DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  members                  WorkspaceMember[]
  roles                    Role[]
  permissions              Permission[]
  rolePermissions          RolePermission[]
  auditLogs                AuditLog[]
  companies                Company[]
  customers                Customer[]
  contacts                 Contact[]
  deals                    Deal[]
  tagOnCompanies           TagOnCompany[]
  tagOnContacts            TagOnContact[]
  tagOnDeals               TagOnDeal[]
  tagOnCustomers           TagOnCustomer[]
  tasks                    Task[]
  tags                     Tag[]
  customFieldDefinitions   CustomFieldDefinition[]
  currentUsers             User[]                    @relation("UserCurrentWorkspace")
  conversations            Conversation[]
  messages                 Message[]
  summaries                ConversationSummary[]
  notifications            Notification[]
  activities               Activity[]
  webhookSubscriptions     WebhookSubscription[]
  integrationAccounts      IntegrationAccount[]
  messageTemplates         MessageTemplate[]
  teams                    Team[]
  queues                   Queue[]
  knowledgeBaseArticles    KnowledgeBaseArticle[]
  cannedResponses          CannedResponse[]
  automationInstances      AutomationInstance[]
  automationAccesses       AutomationAccess[]
  automationAccessRequests AutomationAccessRequest[]
  marketplaceInterests     MarketplaceInterest[]
  variables                WorkspaceVariable[]
  subscriptions            Subscription[]
  aiUsageLogs              AiUsageLog[]
  membershipRequests       WorkspaceMembership[]
  workspaceAgents          WorkspaceAgent[]
  agentAuditLogs           AgentAuditLog[]

  @@index([deletedAt])
}

model WorkspaceMembership {
  id          String                    @id @default(uuid())
  workspaceId String
  userId      String
  role        WorkspaceMembershipRole   @default(MEMBER)
  status      WorkspaceMembershipStatus @default(PENDING)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId, status])
  @@index([workspaceId, status])
}

model User {
  id                 String   @id @default(uuid())
  email              String   @unique
  name               String
  contact            String   @default("")
  role               UserRole @default(USER)
  isSuperAdmin       Boolean  @default(false)
  refreshTokenHash   String?
  currentWorkspaceId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  memberships                       WorkspaceMember[]
  auditLogs                         AuditLog[]
  assignedTasks                     Task[]                      @relation("TaskAssignee")
  assignedConversations             Conversation[]              @relation("ConversationAssignee")
  notifications                     Notification[]
  activities                        Activity[]
  teamMemberships                   TeamMember[]
  automationTemplatesCreated        AutomationTemplate[]        @relation("AutomationTemplateAdmin")
  automationTemplateVersionsCreated AutomationTemplateVersion[] @relation("AutomationTemplateVersionAdmin")
  automationInstancesCreated        AutomationInstance[]        @relation("AutomationInstanceUser")
  automationAccessGranted           AutomationAccess[]          @relation("AutomationAccessAdmin")
  automationAccessRequests          AutomationAccessRequest[]   @relation("AutomationAccessRequester")
  marketplaceInterests              MarketplaceInterest[]       @relation("MarketplaceInterestRequester")
  whatsappSessions                  WhatsappSession[]
  currentWorkspace                  Workspace?                  @relation("UserCurrentWorkspace", fields: [currentWorkspaceId], references: [id])
  workspaceMemberships              WorkspaceMembership[]
  createdAgentTemplates             AgentTemplate[]        @relation("AgentTemplateCreator")
  createdAgentTemplateVersions      AgentTemplateVersion[] @relation("AgentTemplateVersionCreator")
  activatedWorkspaceAgents          WorkspaceAgent[]       @relation("WorkspaceAgentActivator")
  agentAuditLogs                    AgentAuditLog[]
}

model OtpCode {
  id        String     @id @default(uuid())
  email     String
  codeHash  String
  purpose   OtpPurpose
  name      String?
  contact   String?
  createdAt DateTime   @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  @@index([email])
  @@index([expiresAt])
}

model Subscription {
  id          String             @id @default(uuid())
  workspaceId String?
  provider    String
  externalId  String             @unique
  status      SubscriptionStatus @default(PENDING)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model WorkspaceMember {
  id             String   @id @default(uuid())
  workspaceId    String
  userId         String
  roleId         String
  allowedTagIds  String[] @default([])
  allowedUnitIds String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([roleId])
}

model Role {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace         @relation(fields: [workspaceId], references: [id])
  members         WorkspaceMember[]
  rolePermissions RolePermission[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Permission {
  id          String   @id @default(uuid())
  workspaceId String
  key         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  rolePermissions RolePermission[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model RolePermission {
  id           String   @id @default(uuid())
  workspaceId  String
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@index([workspaceId])
  @@index([roleId])
  @@index([permissionId])
}

model AuditLog {
  id          String      @id @default(uuid())
  workspaceId String
  userId      String
  action      AuditAction
  entity      String
  entityId    String
  metadata    Json?
  createdAt   DateTime    @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
}

model Company {
  id           String    @id @default(uuid())
  workspaceId  String
  name         String
  domain       String?
  phone        String?
  customFields Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  version      Int       @default(1)

  workspace Workspace      @relation(fields: [workspaceId], references: [id])
  contacts  Contact[]
  customers Customer[]
  tags      TagOnCompany[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model Customer {
  id           String         @id @default(uuid())
  workspaceId  String
  type         CustomerType   @default(PERSON)
  status       CustomerStatus @default(LEAD)
  name         String
  legalName    String?
  document     String?
  email        String?
  phone        String?
  mobile       String?
  birthDate    DateTime?
  jobTitle     String?
  companyId    String?
  addressLine1 String?
  addressLine2 String?
  neighborhood String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  notes        String?
  customFields Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace Workspace       @relation(fields: [workspaceId], references: [id])
  company   Company?        @relation(fields: [companyId], references: [id], onDelete: SetNull)
  tags      TagOnCustomer[]

  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([workspaceId, document])
  @@index([companyId])
}

model Contact {
  id             String    @id @default(uuid())
  workspaceId    String
  name           String
  email          String?
  phone          String?
  companyId      String?
  leadScore      Int?
  leadScoreLabel String?
  customFields   Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  version        Int       @default(1)

  workspace     Workspace      @relation(fields: [workspaceId], references: [id])
  company       Company?       @relation(fields: [companyId], references: [id])
  tags          TagOnContact[]
  conversations Conversation[]
  deals         Deal[]

  @@unique([workspaceId, phone])
  @@index([workspaceId])
  @@index([companyId])
}

model Conversation {
  id                       String             @id @default(uuid())
  workspaceId              String
  contactId                String
  status                   ConversationStatus @default(OPEN)
  assignedToUserId         String?
  queueId                  String?
  channel                  String
  lastMessageAt            DateTime?
  firstResponseTimeSeconds Int?               @map("first_response_time_seconds")
  resolutionTimeSeconds    Int?               @map("resolution_time_seconds")
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  workspace      Workspace             @relation(fields: [workspaceId], references: [id])
  contact        Contact               @relation(fields: [contactId], references: [id])
  assignedToUser User?                 @relation("ConversationAssignee", fields: [assignedToUserId], references: [id])
  queue          Queue?                @relation(fields: [queueId], references: [id], onDelete: SetNull)
  messages       Message[]
  notifications  Notification[]
  summaries      ConversationSummary[]

  @@index([workspaceId])
  @@index([contactId])
  @@index([assignedToUserId])
  @@index([queueId])
  @@index([workspaceId, status])
}

model Message {
  id                String           @id @default(uuid())
  workspaceId       String
  conversationId    String
  direction         MessageDirection
  text              String
  providerMessageId String?
  sentAt            DateTime
  meta              Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@unique([workspaceId, providerMessageId])
  @@index([workspaceId])
  @@index([conversationId])
  @@index([workspaceId, sentAt])
}

model ConversationSummary {
  id             String   @id @default(uuid())
  workspaceId    String
  conversationId String
  text           String
  bullets        Json
  createdAt      DateTime @default(now())

  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([conversationId])
  @@index([workspaceId, conversationId])
}

model IntegrationAccount {
  id          String                   @id @default(uuid())
  workspaceId String
  type        IntegrationAccountType
  name        String
  status      IntegrationAccountStatus
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt

  workspace Workspace          @relation(fields: [workspaceId], references: [id])
  secret    IntegrationSecret?
  sessions  WhatsappSession[]

  @@index([workspaceId])
}

model WhatsappSession {
  id                   String   @id @default(uuid())
  integrationAccountId String
  profileUserId        String
  provider             String
  sessionName          String
  status               String   @default("pending")
  qrCode               String?
  metadata             Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)
  profileUser        User               @relation(fields: [profileUserId], references: [id], onDelete: Cascade)

  @@unique([integrationAccountId, profileUserId, sessionName])
  @@index([integrationAccountId])
  @@index([profileUserId])
}

model IntegrationSecret {
  id                   String   @id @default(uuid())
  integrationAccountId String   @unique
  encryptedPayload     String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  @@index([integrationAccountId])
}

model AgentTemplate {
  id            String              @id @default(uuid())
  name          String
  slug          String              @unique
  description   String?
  category      String
  channel       String?
  tags          String[]            @default([])
  compatibility String[]            @default([])
  allowedPlans  String[]            @default([])
  status        AgentTemplateStatus @default(DRAFT)
  iconUrl       String?
  priceLabel    String?
  createdById   String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  createdBy  User                   @relation("AgentTemplateCreator", fields: [createdById], references: [id])
  versions   AgentTemplateVersion[]
  workspaces WorkspaceAgent[]
  auditLogs  AgentAuditLog[]

  @@index([status, category])
}

model AgentTemplateVersion {
  id                 String   @id @default(uuid())
  agentTemplateId    String
  version            Int
  sourceJson         Json
  normalizedJson     Json
  validationReport   Json
  requiredVariables  Json?
  n8nWorkflowId      String?
  publishedAt        DateTime?
  createdById        String
  createdAt          DateTime @default(now())

  agentTemplate AgentTemplate   @relation(fields: [agentTemplateId], references: [id], onDelete: Cascade)
  createdBy     User            @relation("AgentTemplateVersionCreator", fields: [createdById], references: [id])
  workspaces    WorkspaceAgent[]
  auditLogs     AgentAuditLog[]

  @@unique([agentTemplateId, version])
  @@index([agentTemplateId, version])
}

model WorkspaceAgent {
  id                     String    @id @default(uuid())
  workspaceId            String
  agentTemplateId        String
  agentTemplateVersionId String
  isActive               Boolean   @default(true)
  configJson             Json
  activatedById          String
  activatedAt            DateTime  @default(now())
  deactivatedAt          DateTime?
  expiresAt              DateTime?
  whatsappSessionId      String?
  assignedByAdminId      String?

  workspace            Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  agentTemplate        AgentTemplate        @relation(fields: [agentTemplateId], references: [id], onDelete: Cascade)
  agentTemplateVersion AgentTemplateVersion @relation(fields: [agentTemplateVersionId], references: [id], onDelete: Cascade)
  activatedBy          User                 @relation("WorkspaceAgentActivator", fields: [activatedById], references: [id])

  @@index([workspaceId, isActive])
  @@index([agentTemplateId])
  @@index([expiresAt])
}

model AgentAuditLog {
  id              String           @id @default(uuid())
  actorId         String
  action          AgentAuditAction
  agentTemplateId String
  versionId       String?
  workspaceId     String?
  metadataJson    Json?
  createdAt       DateTime         @default(now())

  actor         User                 @relation(fields: [actorId], references: [id])
  agentTemplate AgentTemplate        @relation(fields: [agentTemplateId], references: [id], onDelete: Cascade)
  version       AgentTemplateVersion? @relation(fields: [versionId], references: [id], onDelete: SetNull)
  workspace     Workspace?           @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  @@index([agentTemplateId])
  @@index([workspaceId])
}

model MessageTemplate {
  id          String   @id @default(uuid())
  workspaceId String
  channel     String
  name        String
  language    String
  content     String
  externalId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, channel, name, language])
  @@index([workspaceId])
}

model Team {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace    @relation(fields: [workspaceId], references: [id])
  members   TeamMember[]
  queues    Queue[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  position  Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  queues Queue[] @relation("QueueLastAssignedMember")

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([teamId, position])
}

model Queue {
  id                   String   @id @default(uuid())
  workspaceId          String
  teamId               String
  name                 String
  channel              String
  isActive             Boolean  @default(true)
  lastAssignedMemberId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  workspace          Workspace      @relation(fields: [workspaceId], references: [id])
  team               Team           @relation(fields: [teamId], references: [id])
  lastAssignedMember TeamMember?    @relation("QueueLastAssignedMember", fields: [lastAssignedMemberId], references: [id], onDelete: SetNull)
  conversations      Conversation[]

  @@unique([workspaceId, channel])
  @@index([workspaceId])
  @@index([teamId])
}

model KnowledgeBaseArticle {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  content     String
  tags        String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, title])
}

model CannedResponse {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  content     String
  tags        String[]
  shortcut    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, title])
}

model Notification {
  id             String           @id @default(uuid())
  workspaceId    String
  userId         String
  conversationId String?
  type           NotificationType
  title          String
  body           String?
  data           Json?
  readAt         DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([conversationId])
  @@index([workspaceId, userId, readAt])
}

model Deal {
  id             String    @id @default(uuid())
  workspaceId    String
  title          String
  amount         Float?
  stage          String?
  contactId      String?
  leadScore      Int?
  leadScoreLabel String?
  customFields   Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  version        Int       @default(1)

  workspace Workspace   @relation(fields: [workspaceId], references: [id])
  contact   Contact?    @relation(fields: [contactId], references: [id], onDelete: SetNull)
  tags      TagOnDeal[]

  @@index([workspaceId])
  @@index([workspaceId, title])
  @@index([contactId])
}

model Tag {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace       @relation(fields: [workspaceId], references: [id])
  companies TagOnCompany[]
  contacts  TagOnContact[]
  deals     TagOnDeal[]
  customers TagOnCustomer[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TagOnCompany {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  companyId   String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag       @relation(fields: [tagId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])

  @@unique([tagId, companyId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([companyId])
}

model TagOnContact {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  contactId   String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag       @relation(fields: [tagId], references: [id])
  contact   Contact   @relation(fields: [contactId], references: [id])

  @@unique([tagId, contactId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([contactId])
}

model TagOnDeal {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  dealId      String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag       @relation(fields: [tagId], references: [id])
  deal      Deal      @relation(fields: [dealId], references: [id])

  @@unique([tagId, dealId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([dealId])
}

model TagOnCustomer {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  customerId  String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag       @relation(fields: [tagId], references: [id])
  customer  Customer  @relation(fields: [customerId], references: [id])

  @@unique([tagId, customerId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([customerId])
}

model Activity {
  id          String         @id @default(uuid())
  workspaceId String
  userId      String
  entityType  ActivityEntity
  entityId    String
  type        ActivityType
  description String
  metadata    Json?
  occurredAt  DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, entityType, entityId])
  @@index([workspaceId, occurredAt])
}

model WebhookSubscription {
  id          String       @id @default(uuid())
  workspaceId String
  event       WebhookEvent
  targetUrl   String
  secret      String?
  headers     Json?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, event])
}

model CustomFieldDefinition {
  id          String            @id @default(uuid())
  workspaceId String
  entity      CustomFieldEntity
  key         String
  label       String
  type        CustomFieldType
  required    Boolean           @default(false)
  options     Json?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, entity, key])
  @@index([workspaceId])
  @@index([workspaceId, entity])
}

model Task {
  id           String     @id @default(uuid())
  workspaceId  String
  title        String
  dueAt        DateTime?
  status       TaskStatus @default(PENDING)
  assignedToId String?
  relatedType  String?
  relatedId    String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?
  version      Int        @default(1)

  workspace  Workspace @relation(fields: [workspaceId], references: [id])
  assignedTo User?     @relation("TaskAssignee", fields: [assignedToId], references: [id])

  @@index([workspaceId])
  @@index([assignedToId])
  @@index([workspaceId, status])
  @@index([workspaceId, dueAt])
}

model AutomationTemplate {
  id                   String                    @id @default(uuid())
  name                 String
  slug                 String?                   @unique
  headline             String?
  description          String?
  version              String
  changelog            String?
  category             String
  definitionJson       Json
  workflowData         Json?
  requiredIntegrations String[]
  tags                 String[]                  @default([])
  capabilities         String[]                  @default([])
  requirements         String[]                  @default([])
  rating               Float                     @default(0)
  responseSlaSeconds   Int                       @default(0)
  priceLabel           String?
  isPublic             Boolean                   @default(false)
  status               MarketplaceTemplateStatus @default(PENDING)
  pingUrl              String?
  configJson           Json?
  currentVersionId     String?                   @unique
  createdByAdminId     String
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  createdByAdmin       User                        @relation("AutomationTemplateAdmin", fields: [createdByAdminId], references: [id])
  currentVersion       AutomationTemplateVersion?  @relation("AutomationTemplateCurrentVersion", fields: [currentVersionId], references: [id])
  versions             AutomationTemplateVersion[]
  instances            AutomationInstance[]
  accessRequests       AutomationAccessRequest[]
  accesses             AutomationAccess[]
  marketplaceInterests MarketplaceInterest[]

  @@index([category])
  @@index([createdByAdminId])
  @@index([status])
}

model MarketplaceCategory {
  id          String   @id
  name        String
  description String
  highlights  String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

model MarketplaceInterest {
  id                String                 @id @default(uuid())
  workspaceId       String
  templateId        String
  requestedByUserId String
  status            AutomationAccessStatus @default(PENDING)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  workspace       Workspace          @relation(fields: [workspaceId], references: [id])
  template        AutomationTemplate @relation(fields: [templateId], references: [id])
  requestedByUser User               @relation("MarketplaceInterestRequester", fields: [requestedByUserId], references: [id])

  @@unique([workspaceId, templateId, requestedByUserId])
  @@index([workspaceId])
  @@index([templateId])
  @@index([status])
}

model AutomationAccess {
  id               String                 @id @default(uuid())
  workspaceId      String
  templateId       String
  status           AutomationAccessStatus @default(APPROVED)
  grantedByAdminId String
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  workspace      Workspace          @relation(fields: [workspaceId], references: [id])
  template       AutomationTemplate @relation(fields: [templateId], references: [id])
  grantedByAdmin User               @relation("AutomationAccessAdmin", fields: [grantedByAdminId], references: [id])

  @@unique([workspaceId, templateId])
  @@index([workspaceId])
  @@index([templateId])
  @@index([status])
}

model AutomationAccessRequest {
  id                String                 @id @default(uuid())
  workspaceId       String
  templateId        String
  requestedByUserId String
  status            AutomationAccessStatus @default(PENDING)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  workspace       Workspace          @relation(fields: [workspaceId], references: [id])
  template        AutomationTemplate @relation(fields: [templateId], references: [id])
  requestedByUser User               @relation("AutomationAccessRequester", fields: [requestedByUserId], references: [id])

  @@unique([workspaceId, templateId])
  @@index([workspaceId])
  @@index([templateId])
  @@index([status])
}

model AutomationTemplateVersion {
  id                   String   @id @default(uuid())
  templateId           String
  version              String
  changelog            String?
  definitionJson       Json
  requiredIntegrations String[]
  createdByAdminId     String
  createdAt            DateTime @default(now())

  template               AutomationTemplate   @relation(fields: [templateId], references: [id])
  currentVersionTemplate AutomationTemplate?  @relation("AutomationTemplateCurrentVersion")
  createdByAdmin         User                 @relation("AutomationTemplateVersionAdmin", fields: [createdByAdminId], references: [id])
  instances              AutomationInstance[]

  @@unique([templateId, version])
  @@index([templateId])
  @@index([createdByAdminId])
}

model AutomationInstance {
  id                 String                   @id @default(uuid())
  workspaceId        String
  templateId         String
  templateVersionId  String?
  status             AutomationInstanceStatus @default(PENDING_CONFIG)
  externalWorkflowId String?
  enabled            Boolean                  @default(false)
  configJson         Json
  workflowData       Json?
  createdByUserId    String
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt

  workspace       Workspace                  @relation(fields: [workspaceId], references: [id])
  template        AutomationTemplate         @relation(fields: [templateId], references: [id])
  templateVersion AutomationTemplateVersion? @relation(fields: [templateVersionId], references: [id])
  createdByUser   User                       @relation("AutomationInstanceUser", fields: [createdByUserId], references: [id])

  @@index([workspaceId])
  @@index([templateId])
  @@index([templateVersionId])
  @@index([createdByUserId])
}

model WorkspaceVariable {
  id             String   @id @default(uuid())
  workspaceId    String
  key            String
  value          String?
  isSensitive    Boolean  @default(false)
  encryptedValue String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model AiUsageLog {
  id           String        @id @default(uuid())
  workspaceId  String
  provider     String
  action       AiUsageAction
  status       AiUsageStatus @default(SUCCESS)
  input        Json
  output       Json?
  errorMessage String?
  createdAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, action])
  @@index([workspaceId, createdAt])
}
