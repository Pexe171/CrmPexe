// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  USER_LOGIN
  USER_LOGOUT
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  ROLE_ASSIGNED
  ROLE_REVOKED
  IMPERSONATION_STARTED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  DONE
  CANCELED
}

enum AutomationInstanceStatus {
  PENDING
  ACTIVE
  FAILED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum MessageDirection {
  IN
  OUT
  SYSTEM
}

enum NotificationType {
  CONVERSATION_ASSIGNED
  INBOUND_MESSAGE
  SLA_BREACH
}

enum CustomFieldEntity {
  COMPANY
  CONTACT
  DEAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  BOOLEAN
}

enum ActivityEntity {
  DEAL
  CONTACT
  COMPANY
}

enum ActivityType {
  CALL
  EMAIL
  NOTE
  MEETING
}

enum WebhookEvent {
  DEAL_WON
  CONTACT_CREATED
}

enum IntegrationAccountType {
  WHATSAPP
  N8N
}

enum IntegrationAccountStatus {
  ACTIVE
  INACTIVE
}

enum OtpPurpose {
  LOGIN
  SIGNUP
}

enum UserRole {
  ADMIN
  USER
}

enum CustomerType {
  PERSON
  COMPANY
}

enum CustomerStatus {
  LEAD
  ACTIVE
  INACTIVE
  CHURNED
}

enum SubscriptionStatus {
  ACTIVE
  PENDING
  IN_PROCESS
  REJECTED
  CANCELED
}

enum AiUsageAction {
  SUMMARIZE_CONVERSATION
  CLASSIFY_LEAD
  SUGGEST_REPLY
  EXTRACT_FIELDS
}

enum AiUsageStatus {
  SUCCESS
  ERROR
}

model HealthCheck {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  deletedAt DateTime?
  retentionEndsAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  roles       Role[]
  permissions Permission[]
  rolePermissions RolePermission[]
  auditLogs   AuditLog[]
  companies   Company[]
  customers   Customer[]
  contacts    Contact[]
  deals       Deal[]
  tagOnCompanies TagOnCompany[]
  tagOnContacts TagOnContact[]
  tagOnDeals     TagOnDeal[]
  tagOnCustomers TagOnCustomer[]
  tasks       Task[]
  tags        Tag[]
  customFieldDefinitions CustomFieldDefinition[]
  currentUsers User[] @relation("UserCurrentWorkspace")
  conversations Conversation[]
  messages     Message[]
  notifications Notification[]
  activities   Activity[]
  webhookSubscriptions WebhookSubscription[]
  integrationAccounts IntegrationAccount[]
  messageTemplates MessageTemplate[]
  automationInstances AutomationInstance[]
  variables WorkspaceVariable[]
  subscriptions Subscription[]
  aiUsageLogs AiUsageLog[]

  @@index([deletedAt])
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  contact      String   @default("")
  role         UserRole @default(USER)
  isSuperAdmin Boolean  @default(false)
  refreshTokenHash String?
  currentWorkspaceId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships WorkspaceMember[]
  auditLogs   AuditLog[]
  assignedTasks Task[] @relation("TaskAssignee")
  assignedConversations Conversation[] @relation("ConversationAssignee")
  notifications Notification[]
  activities Activity[]
  automationTemplatesCreated AutomationTemplate[] @relation("AutomationTemplateAdmin")
  automationTemplateVersionsCreated AutomationTemplateVersion[] @relation("AutomationTemplateVersionAdmin")
  automationInstancesCreated AutomationInstance[] @relation("AutomationInstanceUser")
  currentWorkspace Workspace? @relation("UserCurrentWorkspace", fields: [currentWorkspaceId], references: [id])
}

model OtpCode {
  id        String     @id @default(uuid())
  email     String
  codeHash  String
  purpose   OtpPurpose
  name      String?
  contact   String?
  createdAt DateTime   @default(now())
  expiresAt DateTime
  usedAt    DateTime?

  @@index([email])
  @@index([expiresAt])
}

model Subscription {
  id        String             @id @default(uuid())
  workspaceId String?
  provider  String
  externalId String           @unique
  status    SubscriptionStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  workspace Workspace? @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  roleId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([roleId])
}

model Role {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  members         WorkspaceMember[]
  rolePermissions RolePermission[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Permission {
  id          String   @id @default(uuid())
  workspaceId String
  key         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  rolePermissions RolePermission[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model RolePermission {
  id           String   @id @default(uuid())
  workspaceId  String
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@index([workspaceId])
  @@index([roleId])
  @@index([permissionId])
}

model AuditLog {
  id          String      @id @default(uuid())
  workspaceId String
  userId      String
  action      AuditAction
  entity      String
  entityId    String
  metadata    Json?
  createdAt   DateTime    @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
}

model Company {
  id           String   @id @default(uuid())
  workspaceId  String
  name         String
  domain       String?
  phone        String?
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  version      Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contacts   Contact[]
  customers  Customer[]
  tags       TagOnCompany[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model Customer {
  id           String         @id @default(uuid())
  workspaceId  String
  type         CustomerType   @default(PERSON)
  status       CustomerStatus @default(LEAD)
  name         String
  legalName    String?
  document     String?
  email        String?
  phone        String?
  mobile       String?
  birthDate    DateTime?
  jobTitle     String?
  companyId    String?
  addressLine1 String?
  addressLine2 String?
  neighborhood String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  notes        String?
  customFields Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  tags      TagOnCustomer[]

  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([workspaceId, document])
  @@index([companyId])
}

model Contact {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  email       String?
  phone       String?
  companyId   String?
  leadScore   Int?
  leadScoreLabel String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  version     Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  company   Company?  @relation(fields: [companyId], references: [id])
  tags      TagOnContact[]
  conversations Conversation[]
  deals     Deal[]

  @@index([workspaceId])
  @@index([companyId])
  @@unique([workspaceId, phone])
}

model Conversation {
  id               String   @id @default(uuid())
  workspaceId      String
  contactId        String
  status           ConversationStatus @default(OPEN)
  assignedToUserId String?
  channel          String
  lastMessageAt    DateTime?
  firstResponseTimeSeconds Int? @map("first_response_time_seconds")
  resolutionTimeSeconds Int? @map("resolution_time_seconds")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contact   Contact   @relation(fields: [contactId], references: [id])
  assignedToUser User? @relation("ConversationAssignee", fields: [assignedToUserId], references: [id])
  messages  Message[]
  notifications Notification[]
  summaries ConversationSummary[]

  @@index([workspaceId])
  @@index([contactId])
  @@index([assignedToUserId])
  @@index([workspaceId, status])
}

model Message {
  id               String   @id @default(uuid())
  workspaceId      String
  conversationId   String
  direction        MessageDirection
  text             String
  providerMessageId String?
  sentAt           DateTime
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([workspaceId])
  @@index([conversationId])
  @@index([workspaceId, sentAt])
  @@unique([workspaceId, providerMessageId])
}

model ConversationSummary {
  id             String   @id @default(uuid())
  workspaceId    String
  conversationId String
  text           String
  bullets        Json
  createdAt      DateTime @default(now())

  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([conversationId])
  @@index([workspaceId, conversationId])
}

model IntegrationAccount {
  id          String   @id @default(uuid())
  workspaceId String
  type        IntegrationAccountType
  name        String
  status      IntegrationAccountStatus
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  secret   IntegrationSecret?

  @@index([workspaceId])
}

model IntegrationSecret {
  id                   String   @id @default(uuid())
  integrationAccountId String   @unique
  encryptedPayload     String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  integrationAccount IntegrationAccount @relation(fields: [integrationAccountId], references: [id], onDelete: Cascade)

  @@index([integrationAccountId])
}

model MessageTemplate {
  id          String   @id @default(uuid())
  workspaceId String
  channel     String
  name        String
  language    String
  content     String
  externalId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, channel, name, language])
  @@index([workspaceId])
}

model Notification {
  id            String   @id @default(uuid())
  workspaceId   String
  userId        String
  conversationId String?
  type          NotificationType
  title         String
  body          String?
  data          Json?
  readAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workspace     Workspace    @relation(fields: [workspaceId], references: [id])
  user          User         @relation(fields: [userId], references: [id])
  conversation  Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([userId])
  @@index([conversationId])
  @@index([workspaceId, userId, readAt])
}

model Deal {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  amount      Float?
  stage       String?
  contactId   String?
  leadScore   Int?
  leadScoreLabel String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  version     Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contact   Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  tags      TagOnDeal[]

  @@index([workspaceId])
  @@index([workspaceId, title])
  @@index([contactId])
}

model Tag {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  companies TagOnCompany[]
  contacts  TagOnContact[]
  deals     TagOnDeal[]
  customers TagOnCustomer[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TagOnCompany {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  companyId  String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag     @relation(fields: [tagId], references: [id])
  company  Company @relation(fields: [companyId], references: [id])

  @@unique([tagId, companyId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([companyId])
}

model TagOnContact {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  contactId  String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag     @relation(fields: [tagId], references: [id])
  contact  Contact @relation(fields: [contactId], references: [id])

  @@unique([tagId, contactId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([contactId])
}

model TagOnDeal {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  dealId     String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag   @relation(fields: [tagId], references: [id])
  deal     Deal  @relation(fields: [dealId], references: [id])

  @@unique([tagId, dealId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([dealId])
}

model TagOnCustomer {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  customerId  String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag      @relation(fields: [tagId], references: [id])
  customer  Customer @relation(fields: [customerId], references: [id])

  @@unique([tagId, customerId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([customerId])
}

model Activity {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  entityType  ActivityEntity
  entityId    String
  type        ActivityType
  description String
  metadata    Json?
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
  @@index([workspaceId, entityType, entityId])
  @@index([workspaceId, occurredAt])
}

model WebhookSubscription {
  id          String   @id @default(uuid())
  workspaceId String
  event       WebhookEvent
  targetUrl   String
  secret      String?
  headers     Json?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, event])
}

model CustomFieldDefinition {
  id          String   @id @default(uuid())
  workspaceId String
  entity      CustomFieldEntity
  key         String
  label       String
  type        CustomFieldType
  required    Boolean  @default(false)
  options     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, entity, key])
  @@index([workspaceId])
  @@index([workspaceId, entity])
}

model Task {
  id          String     @id @default(uuid())
  workspaceId String
  title       String
  dueAt       DateTime?
  status      TaskStatus @default(PENDING)
  assignedToId String?
  relatedType String?
  relatedId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  version     Int        @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  assignedTo User? @relation("TaskAssignee", fields: [assignedToId], references: [id])

  @@index([workspaceId])
  @@index([assignedToId])
  @@index([workspaceId, status])
  @@index([workspaceId, dueAt])
}

model AutomationTemplate {
  id                   String   @id @default(uuid())
  name                 String
  description          String?
  version              String
  changelog            String?
  category             String
  definitionJson       Json
  requiredIntegrations String[]
  currentVersionId     String?
  createdByAdminId     String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  createdByAdmin User @relation("AutomationTemplateAdmin", fields: [createdByAdminId], references: [id])
  currentVersion AutomationTemplateVersion? @relation("AutomationTemplateCurrentVersion", fields: [currentVersionId], references: [id])
  versions      AutomationTemplateVersion[]
  instances     AutomationInstance[]

  @@index([category])
  @@index([createdByAdminId])
}

model AutomationTemplateVersion {
  id                   String   @id @default(uuid())
  templateId           String
  version              String
  changelog            String?
  definitionJson       Json
  requiredIntegrations String[]
  createdByAdminId     String
  createdAt            DateTime @default(now())

  template      AutomationTemplate @relation(fields: [templateId], references: [id])
  createdByAdmin User @relation("AutomationTemplateVersionAdmin", fields: [createdByAdminId], references: [id])
  instances     AutomationInstance[]

  @@unique([templateId, version])
  @@index([templateId])
  @@index([createdByAdminId])
}

model AutomationInstance {
  id              String                    @id @default(uuid())
  workspaceId     String
  templateId      String
  templateVersionId String?
  status          AutomationInstanceStatus  @default(PENDING)
  externalWorkflowId String?
  enabled         Boolean                   @default(false)
  configJson      Json
  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  workspace     Workspace          @relation(fields: [workspaceId], references: [id])
  template      AutomationTemplate @relation(fields: [templateId], references: [id])
  templateVersion AutomationTemplateVersion? @relation(fields: [templateVersionId], references: [id])
  createdByUser User               @relation("AutomationInstanceUser", fields: [createdByUserId], references: [id])

  @@index([workspaceId])
  @@index([templateId])
  @@index([templateVersionId])
  @@index([createdByUserId])
}

model WorkspaceVariable {
  id             String   @id @default(uuid())
  workspaceId    String
  key            String
  value          String?
  isSensitive    Boolean  @default(false)
  encryptedValue String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model AiUsageLog {
  id           String        @id @default(uuid())
  workspaceId  String
  provider     String
  action       AiUsageAction
  status       AiUsageStatus @default(SUCCESS)
  input        Json
  output       Json?
  errorMessage String?
  createdAt    DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, action])
  @@index([workspaceId, createdAt])
}
