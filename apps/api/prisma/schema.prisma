// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  USER_LOGIN
  USER_LOGOUT
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  ROLE_ASSIGNED
  ROLE_REVOKED
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  DONE
  CANCELED
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum MessageDirection {
  IN
  OUT
  SYSTEM
}

enum CustomFieldEntity {
  COMPANY
  CONTACT
  DEAL
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  BOOLEAN
}

enum CustomerType {
  PERSON
  COMPANY
}

enum CustomerStatus {
  LEAD
  ACTIVE
  INACTIVE
  CHURNED
}

model HealthCheck {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  roles       Role[]
  permissions Permission[]
  rolePermissions RolePermission[]
  auditLogs   AuditLog[]
  companies   Company[]
  customers   Customer[]
  contacts    Contact[]
  deals       Deal[]
  tagOnCompanies TagOnCompany[]
  tagOnContacts TagOnContact[]
  tagOnDeals     TagOnDeal[]
  tagOnCustomers TagOnCustomer[]
  tasks       Task[]
  tags        Tag[]
  customFieldDefinitions CustomFieldDefinition[]
  currentUsers User[] @relation("UserCurrentWorkspace")
  conversations Conversation[]
  messages     Message[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  refreshTokenHash String?
  currentWorkspaceId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships WorkspaceMember[]
  auditLogs   AuditLog[]
  assignedTasks Task[] @relation("TaskAssignee")
  assignedConversations Conversation[] @relation("ConversationAssignee")
  currentWorkspace Workspace? @relation("UserCurrentWorkspace", fields: [currentWorkspaceId], references: [id])
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  roleId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([roleId])
}

model Role {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  members         WorkspaceMember[]
  rolePermissions RolePermission[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Permission {
  id          String   @id @default(uuid())
  workspaceId String
  key         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  rolePermissions RolePermission[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model RolePermission {
  id           String   @id @default(uuid())
  workspaceId  String
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@index([workspaceId])
  @@index([roleId])
  @@index([permissionId])
}

model AuditLog {
  id          String      @id @default(uuid())
  workspaceId String
  userId      String
  action      AuditAction
  entity      String
  entityId    String
  metadata    Json?
  createdAt   DateTime    @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
}

model Company {
  id           String   @id @default(uuid())
  workspaceId  String
  name         String
  domain       String?
  phone        String?
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  version      Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contacts   Contact[]
  customers  Customer[]
  tags       TagOnCompany[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model Customer {
  id           String         @id @default(uuid())
  workspaceId  String
  type         CustomerType   @default(PERSON)
  status       CustomerStatus @default(LEAD)
  name         String
  legalName    String?
  document     String?
  email        String?
  phone        String?
  mobile       String?
  birthDate    DateTime?
  jobTitle     String?
  companyId    String?
  addressLine1 String?
  addressLine2 String?
  neighborhood String?
  city         String?
  state        String?
  postalCode   String?
  country      String?
  notes        String?
  customFields Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  tags      TagOnCustomer[]

  @@index([workspaceId])
  @@index([workspaceId, name])
  @@index([workspaceId, document])
  @@index([companyId])
}

model Contact {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  email       String?
  phone       String?
  companyId   String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  version     Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  company   Company?  @relation(fields: [companyId], references: [id])
  tags      TagOnContact[]
  conversations Conversation[]

  @@index([workspaceId])
  @@index([companyId])
}

model Conversation {
  id               String   @id @default(uuid())
  workspaceId      String
  contactId        String
  status           ConversationStatus @default(OPEN)
  assignedToUserId String?
  channel          String
  lastMessageAt    DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contact   Contact   @relation(fields: [contactId], references: [id])
  assignedToUser User? @relation("ConversationAssignee", fields: [assignedToUserId], references: [id])
  messages  Message[]

  @@index([workspaceId])
  @@index([contactId])
  @@index([assignedToUserId])
  @@index([workspaceId, status])
}

model Message {
  id               String   @id @default(uuid())
  workspaceId      String
  conversationId   String
  direction        MessageDirection
  text             String
  providerMessageId String?
  sentAt           DateTime
  meta             Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  workspace    Workspace    @relation(fields: [workspaceId], references: [id])
  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([workspaceId])
  @@index([conversationId])
  @@index([providerMessageId])
  @@index([workspaceId, sentAt])
}

model Deal {
  id          String   @id @default(uuid())
  workspaceId String
  title       String
  amount      Float?
  stage       String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  version     Int      @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tags      TagOnDeal[]

  @@index([workspaceId])
  @@index([workspaceId, title])
}

model Tag {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  companies TagOnCompany[]
  contacts  TagOnContact[]
  deals     TagOnDeal[]
  customers TagOnCustomer[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TagOnCompany {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  companyId  String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag     @relation(fields: [tagId], references: [id])
  company  Company @relation(fields: [companyId], references: [id])

  @@unique([tagId, companyId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([companyId])
}

model TagOnContact {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  contactId  String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag     @relation(fields: [tagId], references: [id])
  contact  Contact @relation(fields: [contactId], references: [id])

  @@unique([tagId, contactId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([contactId])
}

model TagOnDeal {
  id         String   @id @default(uuid())
  workspaceId String
  tagId      String
  dealId     String
  createdAt  DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag      Tag   @relation(fields: [tagId], references: [id])
  deal     Deal  @relation(fields: [dealId], references: [id])

  @@unique([tagId, dealId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([dealId])
}

model TagOnCustomer {
  id          String   @id @default(uuid())
  workspaceId String
  tagId       String
  customerId  String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  tag       Tag      @relation(fields: [tagId], references: [id])
  customer  Customer @relation(fields: [customerId], references: [id])

  @@unique([tagId, customerId])
  @@index([workspaceId])
  @@index([tagId])
  @@index([customerId])
}

model CustomFieldDefinition {
  id          String   @id @default(uuid())
  workspaceId String
  entity      CustomFieldEntity
  key         String
  label       String
  type        CustomFieldType
  required    Boolean  @default(false)
  options     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, entity, key])
  @@index([workspaceId])
  @@index([workspaceId, entity])
}

model Task {
  id          String     @id @default(uuid())
  workspaceId String
  title       String
  dueAt       DateTime?
  status      TaskStatus @default(PENDING)
  assignedToId String?
  relatedType String?
  relatedId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  deletedAt   DateTime?
  version     Int        @default(1)

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  assignedTo User? @relation("TaskAssignee", fields: [assignedToId], references: [id])

  @@index([workspaceId])
  @@index([assignedToId])
  @@index([workspaceId, status])
  @@index([workspaceId, dueAt])
}
