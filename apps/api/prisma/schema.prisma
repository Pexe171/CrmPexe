// apps/api/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  USER_LOGIN
  USER_LOGOUT
  WORKSPACE_CREATED
  WORKSPACE_UPDATED
  ROLE_ASSIGNED
  ROLE_REVOKED
}

model HealthCheck {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     WorkspaceMember[]
  roles       Role[]
  permissions Permission[]
  auditLogs   AuditLog[]
  companies   Company[]
  currentUsers User[] @relation("UserCurrentWorkspace")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  passwordHash String
  refreshTokenHash String?
  currentWorkspaceId String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships WorkspaceMember[]
  auditLogs   AuditLog[]
  currentWorkspace Workspace? @relation("UserCurrentWorkspace", fields: [currentWorkspaceId], references: [id])
}

model WorkspaceMember {
  id          String   @id @default(uuid())
  workspaceId String
  userId      String
  roleId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])
  role      Role      @relation(fields: [roleId], references: [id])

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@index([roleId])
}

model Role {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  members         WorkspaceMember[]
  rolePermissions RolePermission[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model Permission {
  id          String   @id @default(uuid())
  workspaceId String
  key         String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace       Workspace        @relation(fields: [workspaceId], references: [id])
  rolePermissions RolePermission[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
}

model RolePermission {
  id           String   @id @default(uuid())
  workspaceId  String
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  workspace  Workspace  @relation(fields: [workspaceId], references: [id])
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([roleId, permissionId])
  @@index([workspaceId])
  @@index([roleId])
  @@index([permissionId])
}

model AuditLog {
  id          String      @id @default(uuid())
  workspaceId String
  userId      String
  action      AuditAction
  entity      String
  entityId    String
  metadata    Json?
  createdAt   DateTime    @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([workspaceId])
  @@index([userId])
}

model Company {
  id           String   @id @default(uuid())
  workspaceId  String
  name         String
  domain       String?
  phone        String?
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  contacts   Contact[]

  @@index([workspaceId])
  @@index([workspaceId, name])
}

model Contact {
  id          String   @id @default(uuid())
  workspaceId String
  name        String
  email       String?
  phone       String?
  companyId   String?
  customFields Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  company   Company?  @relation(fields: [companyId], references: [id])

  @@index([workspaceId])
  @@index([companyId])
}
